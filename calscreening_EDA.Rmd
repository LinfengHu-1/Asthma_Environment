---
title: "calscreening2018"
author: "Group 21; Group name: 21 and me; Members: Pluto Zhang, Linfeng Hu, Cynthia Ma"
date: "2022-10-26"
output: html_document
---

```{r}
library(rstudioapi)
library(tidyverse)
library(gam)
library(splines)
library(splines2)  
library(dplyr)
library(tidyr)
library(broom)
library(dslabs)
library(ggplot2)
library(ggthemes)
library(ggrepel)
library(data.table)
library(nnet)
library(VGAM)
```

```{r}
data_cal <- read_csv('calenviroscreen-3.0-results-june-2018-update.csv')
data_cal
```


```{r}
summary(data_cal)
```

```{r}
#names(data_cal)
colnames(data_cal) <- gsub(" ", "", colnames(data_cal))
colnames(data_cal) <- gsub("\n", "", colnames(data_cal))
names(data_cal)
```
***
columns for diseases: Asthma LowBirthWeight CardiovascularDisease

columns for socio-economic elements:
ducation LinguisticIsolation Poverty Unemployment HousingBurden Pop.Char.

columns for air pollution elements: 
Ozone PM2.5 DieselPM DrinkingWater Pesticides Tox.Release
Traffic CleanupSites GroundwaterThreats Haz.Waste Imp.WaterBodies
SolidWaste PollutionBurden
*****

```{r}
air_pollutants_vec <- names(data_cal)[12:38]
air_pollutants_vec

disease_vec <- names(data_cal)[39:44]
disease_vec

soecon_vec <- names(data_cal)[45:57]
soecon_vec
```

# EDA

## EDA for Pollution factors
```{r}
#histograms for the air pollution factors
hist(data_cal$Ozone, main='Histogram of state-level Ozone concentration in the air' )

hist(data_cal$PM2.5, main='Histogram of state-level PM 2.5 concentration in the air' )

hist(data_cal$DieselPM, main='Histogram of state-level Diesel Particle concentration in the air' )

hist(data_cal$Pesticides, main='Histogram of state-level Pesticides concentration in the air' )

hist(data_cal$Tox.Release, main='Histogram of state-level Toxin concentration in the air' )


pairs(Asthma ~ Ozone + PM2.5 + DieselPM + Pesticides + Tox.Release , dat = data_cal)
```

# for other diseases

```{r}
#histograms for the other diseases factors
hist(data_cal$Asthma, main='Histogram of state-level Asthma rate(age-adjusted)' )

hist(data_cal$LowBirthWeight, main='Histogram of Low Birth Weight Prevalence' )

hist(data_cal$CardiovascularDisease, main='Histogram of state-level Cardiovascular Diseases Prevalence' )


pairs(Asthma ~ LowBirthWeight + CardiovascularDisease , dat = data_cal)
```


#for socioeconomic factors
```{r}
pairs(Asthma ~ Education + LinguisticIsolation + Poverty + Unemployment + HousingBurden, dat = data_cal)
#pairs(Pop.Char.~ Education + LinguisticIsolation + Poverty + Unemployment + HousingBurden, dat = data_cal)
```


```{r}
#forward selection
require(broom)
data_cal1 <- na.omit(data_cal)
#forward selection procedure using AIC values 
lm1 <- lm(Asthma ~ 1, data=data_cal1)
stepModel <- step(lm1, direction="forward",
scope=(~ Ozone + PM2.5 + DieselPM+ DrinkingWater+Pesticides+Tox.Release+Traffic +CleanupSites + GroundwaterThreats+ Haz.Waste + Imp.WaterBodies + 
SolidWaste + Education+LinguisticIsolation+Poverty+Unemployment+HousingBurden+ LowBirthWeight+CardiovascularDisease), data=data_cal1)

```
The desired model: 
Asthma ~ CardiovascularDisease + Poverty + Ozone + LowBirthWeight + 
    LinguisticIsolation + DieselPM + DrinkingWater + Unemployment + 
    GroundwaterThreats + Tox.Release + PM2.5 + CleanupSites + 
    PollutionBurden + Imp.WaterBodies + HousingBurden + Traffic + 
    Pesticides + Haz.Waste
    
```{r}
#stepwise selection
lm_stepwise <- lm(Asthma ~ Ozone + PM2.5 + DieselPM+ DrinkingWater+Pesticides+Tox.Release+Traffic +CleanupSites + GroundwaterThreats+ Haz.Waste + Imp.WaterBodies + 
SolidWaste + PollutionBurden + Education+LinguisticIsolation+Poverty+Unemployment+HousingBurden+LowBirthWeight+CardiovascularDisease, data=data_cal1)
stepModel <- step(lm_stepwise, direction="both")
```

The stepwise model selection method and forward selection method outputs match each other. Combined with our subject matter knowledge, we will proceed with modeling using the following covariates: Ozone + PM2.5 + DieselPM + DrinkingWater + Pesticides + 
    Tox.Release + Traffic + CleanupSites + GroundwaterThreats + 
    Haz.Waste + Imp.WaterBodies + PollutionBurden + LinguisticIsolation + 
    Poverty + Unemployment + HousingBurden + LowBirthWeight + 
    CardiovascularDisease

#### Missing Data
```{r}
#check for missing data
anyNA(data_cal)
colnames(data_cal)[colSums(is.na(data_cal)) > 0]
sum(is.na(data_cal$PM2.5))
```
covariates with missing data: CES 3.0 Score, PM2.5, DrinkingWater, Traffic, LowBirthWeight, Education, LinguisticIsolation, Poverty, Unemployment, HousingBurden, Population characteristics.
```{r}
#look at rows with missing data
dat_NA <- data_cal[!complete.cases(data_cal), ]
rowSums(is.na(dat_NA))
#look at missing pattern
library(ggmice)
dat <- data_cal |> select(Asthma, Ozone, PM2.5, DieselPM, DrinkingWater, Poverty, Unemployment, LowBirthWeight, CardiovascularDisease)
plot_pattern(dat)
```
```{r}
#Attempt Multivariate Imputation
library(mice)
tempData = mice(dat, m = 5, maxit = 25, seed = 210)
summary(tempData)
complete(tempData,action=1)
```


#### Modeling
```{r}
#vector of covariates of interest
vec_cov <- c("Ozone", "PM2.5", "DieselPM", "LinguisticIsolation", "Poverty", "Unemployment", "LowBirthWeight")
```


##### Linear, additive, or other models (LASSO, ridge)
```{r}
lm_pureLinear = lm(Asthma ~ Ozone + PM2.5 + DieselPM + DrinkingWater + Pesticides + Tox.Release + Traffic + CleanupSites + GroundwaterThreats + Haz.Waste + Imp.WaterBodies + PollutionBurden + LinguisticIsolation + Poverty + Unemployment + HousingBurden + LowBirthWeight + CardiovascularDisease, data=data_cal1)
summary(lm_pureLinear)
confint(lm_pureLinear)
#Evaluation for this simple linear model
plot(lm_pureLinear)
```
This simple linear model is unsatisfactory. We can see from the plot of Residuals vs. Fitted that there's fanning trend, no equal variance above and below the line. The QQ-plot also shows non-normality with clear deviation from the diagonal line on both ends of the fitted curve.

- pesticides, traffic, hazard waste are not statistically significant. We may consider removing these covariates.

- Housing burden as a lower significance level (higher p-value) compared to other covariates may consider removing it from linear model as well.


```{r}
#remove coefficients with lower significance level, include only if coefficients are coded "***" significant
lm_rmSig = lm(Asthma ~ Ozone + PM2.5 + DieselPM + DrinkingWater + Tox.Release + CleanupSites + GroundwaterThreats + Imp.WaterBodies + PollutionBurden + LinguisticIsolation + Poverty + Unemployment + LowBirthWeight + CardiovascularDisease, data=data_cal1)
summary(lm_rmSig)
confint(lm_rmSig)
#Evaluation for this simple linear model
plot(lm_rmSig)
```
```{r}
#leave coefficients with significant level <2e-16
lm_highSig = lm(Asthma ~ Ozone + PM2.5 + DieselPM + DrinkingWater + LinguisticIsolation + Poverty + Unemployment + LowBirthWeight + CardiovascularDisease, data=data_cal1)
summary(lm_highSig)
confint(lm_highSig)
#Evaluation for this simple linear model
plot(lm_highSig)
```


```{r}
#add spline term to every term with significance level <2e-16 & PM2.5
model_spline=lm(Asthma~bSpline(Ozone,df=4) + bSpline(PM2.5, df=4) + bSpline(DieselPM, df=4) + bSpline(DrinkingWater, df=4) + Tox.Release + CleanupSites + GroundwaterThreats + Imp.WaterBodies + PollutionBurden + bSpline(LinguisticIsolation, df=4) + bSpline(Poverty, df=4) + bSpline(Unemployment, df=4) + bSpline(LowBirthWeight, df=4) + bSpline(CardiovascularDisease, df=4), data=data_cal1)
summary(model_spline)
#model evaluation
plot(model_spline)
```

```{r}
#Ridge
library(dplyr)
#define outcome variable
y <- data_cal1 |> select(Asthma) |> scale(center = TRUE, scale = FALSE) |> as.matrix()
#define matrix of predictor variables
x <- data_cal1[, c("Ozone", "PM2.5", "DieselPM", "DrinkingWater", "LinguisticIsolation",  "Poverty", "Unemployment", "LowBirthWeight", "CardiovascularDisease")] |> as.matrix()
library(glmnet)
#fit ridge regression model
lambda_seq <- 10^seq(2, -2, by = -.1)
mod_ridge <- glmnet(x, y,alpha=0.5,family="gaussian",lambda = lambda_seq)
best_lambda <- mod_ridge$lambda.min
best_lambda


# library(MASS)
# fit = lm.ridge(Asthma ~ Ozone + PM2.5 + DieselPM + DrinkingWater + LinguisticIsolation + Poverty + Unemployment + LowBirthWeight + CardiovascularDisease, data_cal1, lambda = seq(0, .4, 1e-3))
# par(mar = c(4, 4, 0, 0), cex = 0.7, las = 1)
# matplot(fit$lambda, coef(fit), type = "l", ylim = c(-1, 3),
#         xlab = expression(lambda), ylab = expression(hat(beta)))


#view summary of model
summary(fit)
plot(fit)
```


```{r}
#Elastic Net
# library(caret)
# # Model Building : Elastic Net Regression
# control <- trainControl(method = "repeatedcv", number = 5, repeats = 5, search = "random", verboseIter = TRUE)
# # Training elastic Net Regression model
# elastic_model <- train(Asthma ~ ., data = cbind(x, y), method = "glmnet", preProcess = c("center", "scale"), tuneLength = 25,trControl = control)
# #elastic_model
# # Model Prediction
# x_hat_pre <- predict(elastic_model, y)
# x_hat_pre
# # Multiple R-squared
# rsq <- cor(x, x_hat_pre)^2
# rsq
# # Plot
# plot(elastic_model, main = "Elastic Net Regression")
library(vip)
elasticnet.mod = glmnet(x,y,alpha=0.5,family="gaussian",lambda = lambda_grid)
vip(elasticnet.mod, num_features=10, geom = "point")
#now we look at the Variable importance (vip) for factors excluding Ozone
x_noOzone <- data_cal1[, c("PM2.5", "DieselPM", "DrinkingWater", "LinguisticIsolation",  "Poverty", "Unemployment", "LowBirthWeight", "CardiovascularDisease")] |> as.matrix()
elasticnet.mod.noOzone = glmnet(x_noOzone,y,alpha=0.5,family="gaussian",lambda = lambda_grid)
vip(elasticnet.mod.noOzone, num_features=10, geom = "point")
```


##### Logistic, Multinomial, Ordinal Model
```{r}

```

##### Poisson
```{r}

library(dplyr)
library(tidyverse)
#round the Asthma rate to make sure that it's integers
dataint <- data_cal1 |> mutate(Asthma = round(Asthma))

mod.poisson.full <- glm(Asthma ~ Ozone + PM2.5 + DieselPM + DrinkingWater + Pesticides + 
    Tox.Release + Traffic + CleanupSites + GroundwaterThreats + 
    Haz.Waste + Imp.WaterBodies + PollutionBurden + LinguisticIsolation + 
    Poverty + Unemployment + HousingBurden + LowBirthWeight + 
    CardiovascularDisease, data=dataint, family=quasipoisson)
summary(mod.poisson.full)


sort(coef(mod.poisson.full) , decreasing = TRUE)


```



From the summary statistics of the full model, the Cardiovascular Disease, Low Birth Weight and PM 2.5 are the three major contributors to Asthma rate, using Poisson models. 
While Ozone is the factor that is negatively correlated with Asthma rate, as is shown in the linear model. 

Since pesticides, traffic, Haz.waste, Imp.WaterBodies, PollutionBurden and Housing burden variables have both relatively lower p-values and small 
Since drinking water, cleanup sites and Ground Water threats have relatively very low coefficients, we exclude their effects for the next round of analysis.  

Thus, what we keep for the next round of analysis are 8 variables: PM2.5, Ozone, DieselPM, Unemployment, Poverty, Linguistic Isolation, Low Birth Weight and Cardiovascular Diseases.



checking for dispersion:

```{r}
deviance(mod.poisson.full)/mod.poisson.full$df.residual
```
Since the quotient is greater than 1, 
There exists some form of overdispersion in the data.

First, we look at the model with the air pollution factors:
We want to approximate the effects of Pmm 2.5 and Asthma
```{r}
mod.p_base <- glm(Asthma ~ PM2.5, data=dataint, family=quasipoisson)
summary(mod.p_base)
exp(coef(mod.p_base)[2])

deviance(mod.p_base)/mod.p_base$df.residual
```

The model with Pm 2.5 alone has very great overdispersion. 

From the summary statistics: we can see that with every 1 more unit increase in PM 2.5 concentration is estimated to be associated with, on average, 2% increase in the incidence rate of asthma among individuals that live in the counties with the current level of PM2.5 concentration.


```{r}
mod.p_pmd <- glm(Asthma ~ PM2.5 + DieselPM, data=dataint, family=poisson())
summary(mod.p_pmd)
exp(coef(mod.p_pmd)[2])
exp(coef(mod.p_pmd)[3])
```
From the summary statistics: we can see that with every 1 more unit increase in PM 2.5 concentration is estimated to be associated with, on average, 1.3% increase in the incidence rate of asthma among individuals that live in the counties with the current level of PM2.5 concentration.

Diesel is likely a confonder for the effects of PM 2.5, because dieselPM contributes to a portion of PM 2.5, while the total PM2.5 amount doesn't directly lead to DieselPM. 
The changes in coefficient of PM 2.5:
(0.02-0.013)/0.013 = 53.8% > 10%
Thus, diesel PM satisfies the confounding effect. 

Then we test the effect modifying of DieselPM:
The interaction terms has a p-value below the significant threshold. SO we can conclude that it is an effect modifier of PM 2.5. 
```{r}
mod.p_pmdinter <- glm(Asthma ~ PM2.5 * DieselPM, data=dataint, family=poisson())
summary(mod.p_pmdinter)
exp(coef(mod.p_pmdinter)[2])
exp(coef(mod.p_pmdinter)[3])
```
Checking for Pm 2.5 + Ozone as the predictor
```{r}
mod.p_ozone <- glm(Asthma ~ PM2.5 + Ozone, data=dataint, family=poisson())
summary(mod.p_ozone)
exp(coef(mod.p_ozone)[2])
exp(coef(mod.p_ozone)[3])
```
From the summary statistics: we can see that with every 1 more unit increase in ozone concentration is estimated to be associated with, on average, 600% increase in the incidence rate of asthma among individuals that live in the counties with the current level of ozone concentration, holding Pm 2.5 constant

Something to note: Ozone showed a very significant positive association with Asthma rate when modeled with Asthma rate alone, but showed negative association in the full model, which is open for later discussion and examinations. 

```{r}

```

<<<<<<< HEAD
Testing whether we can use the other two diseases as predictors for Asthma rate:
```{r}

#coef(mod.p_ozone)
mod.p_diseases <- glm(Asthma ~ LowBirthWeight+CardiovascularDisease, data=dataint, family=quasipoisson)
summary(mod.p_diseases)
exp(coef(mod.p_diseases)[2])
exp(coef(mod.p_diseases)[3])

summary(mod.p_diseases)$dispersion
```
we can see that every 1 unit increase in percent of population with cardiovascular disease is estimated to be associated with, on average, 11% increase in the incidence rate of asthma among individuals that live in the counties with the current level of PM2.5 concentration, holding other variables constant.

With every 1 unit increase in percent of population with Low Birth Weight, is estimated to be associated with, on average, 8% increase in the incidence rate of asthma among individuals that live in the counties with the current level of PM2.5 concentration, holding other variables constant.

Testing whether socioeconomic factors can be prediction factors for Asthma. 
```{r}
mod.p_soecon <- glm(Asthma ~ Poverty + Unemployment + LinguisticIsolation, data=dataint, family=poisson())
summary(mod.p_soecon)
```
poverty and unemployment both demonstrated positive relationship with Asthma, while linguistic isolation demonstrated negative relationship with Asthma. 


Next, incoporating the quadratic terms of PM2.5, Diesel PM, Ozone into the model:

Hypothesis testing: comparing the linear simple model with the 8 variables, to the model that has the quadratic terms of the three environmental factors PM 2.5, Ozone and DieselPM.

Hypothesis H0: this new model is better in terms of predicting the Asthma compared to the simple model


```{r}
mod.poisson.sim <- glm(Asthma ~ Ozone + PM2.5 + DieselPM + LinguisticIsolation + 
    Poverty + Unemployment+ LowBirthWeight +
    CardiovascularDisease , data=dataint, family=quasipoisson)
summary(mod.poisson.sim)

mod.poisson.qua <- glm(Asthma ~ Ozone + PM2.5 + DieselPM + LinguisticIsolation + 
    Poverty + Unemployment+ LowBirthWeight + 
    CardiovascularDisease + I(Ozone^2) + I(PM2.5^2) + I(DieselPM ^2), data=dataint, family=quasipoisson)
summary(mod.poisson.qua)

anova(mod.poisson.sim,mod.poisson.qua, test ='Chisq')
```


Since the p-value is lower than zero, it's sufficient for us to reject the null hypothesis. Thus, the model with quadratic terms is better in predicting Asthma rate, as compared to the simple model. 



Check for overdispersion:
```{r}
summary(mod.poisson.qua)$dispersion
summary(mod.poisson.sim)$dispersion
```
The quadratic model has smaller overdispersion quotient than the linear model, which indicates that it has better goodness of fit. 

Next: to remedy for the overdispersion effects, we consider incorporating the negative binomial model: 

```{r}
nbin1 <- MASS::glm.nb(Asthma ~ Ozone + PM2.5 + DieselPM + LinguisticIsolation + 
    Poverty + Unemployment+ LowBirthWeight + 
    CardiovascularDisease + I(Ozone^2) + I(PM2.5^2) + I(DieselPM ^2), data = dataint)
summary(nbin1)
```
```{r}
summary(nbin1)$dispersion
```
The negative binomial model has dispersion quotient of 1, and all the terms are statistically significant with p-values much smaller than the 0.05 threshold. Thus, it's a desirable model at this step. 
=======

```{r}
#multinomial regression
data_cal <- data_cal %>% mutate(asthma_cat = case_when(
  AsthmaPctl <=25 ~ 1,
  AsthmaPctl <=50 ~ 2,
  AsthmaPctl <=75 ~ 3,
  AsthmaPctl <=100 ~ 4
))

summ.MNfit <- function(fit, digits=3){
  s <- summary(fit)
  for(i in 2:length(fit$lev)) {
##
cat("\nLevel", fit$lev[i], "vs. Level", fit$lev[1], "\n")
##
betaHat <- s$coefficients[(i-1),]
se <- s$standard.errors[(i-1),]
zStat <- betaHat / se
pval <- 2 * pnorm(abs(zStat), lower.tail=FALSE)
##
RRR <- exp(betaHat)
RRR.lower <- exp(betaHat - qnorm(0.975)*se)
RRR.upper <- exp(betaHat + qnorm(0.975)*se)
##
results <- cbind(betaHat, se, pval, RRR, RRR.lower, RRR.upper)
print(round(results, digits=digits))
}
}

mod.multi <- multinom(asthma_cat ~ Ozone + PM2.5 + DieselPM + DrinkingWater + Pesticides + 
    Tox.Release + Traffic + CleanupSites + GroundwaterThreats + 
    Haz.Waste + Imp.WaterBodies + PollutionBurden + LinguisticIsolation + 
    Poverty + Unemployment + HousingBurden + LowBirthWeight + 
    CardiovascularDisease, data=data_cal)

summ.MNfit(mod.multi)

mod.ord <- vglm(asthma_cat ~ Ozone + PM2.5 + DieselPM + DrinkingWater + Pesticides + 
    Tox.Release + Traffic + CleanupSites + GroundwaterThreats + 
    Haz.Waste + Imp.WaterBodies + PollutionBurden + LinguisticIsolation + 
    Poverty + Unemployment + HousingBurden + LowBirthWeight + 
    CardiovascularDisease, cumulative(parallel=TRUE, reverse=TRUE),data=data_cal)

summary(mod.ord)

mod.ord.npo <- vglm(asthma_cat ~ Ozone + PM2.5 + DieselPM + DrinkingWater + Pesticides + 
    Tox.Release + Traffic + CleanupSites + GroundwaterThreats + 
    Haz.Waste + Imp.WaterBodies + PollutionBurden + LinguisticIsolation + 
    Poverty + Unemployment + HousingBurden + LowBirthWeight + 
    CardiovascularDisease, cumulative(parallel=FALSE, reverse=TRUE),data=data_cal)

pchisq(deviance(mod.ord)-deviance(mod.ord.npo), df=df.residual(mod.ord)-df.residual(mod.ord.npo),lower.tail=F)
#proportional odds does not hold --> use multinomial


```

>>>>>>> b70d94225c7403cb1e4019b4f16bd84c3b2b3a43
