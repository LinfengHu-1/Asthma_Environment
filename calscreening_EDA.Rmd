---
title: "calscreening2018"
author: "Group 21; Group name: 21 and me; Members: Pluto Zhang, Linfeng Hu, Cynthia Ma"
date: "2022-10-26"
output: html_document
---

```{r}
library(rstudioapi)
library(tidyverse)
library(gam)
library(splines)
library(splines2)  
library(dplyr)
library(tidyr)
library(broom)
library(dslabs)
library(ggplot2)
library(ggthemes)
library(ggrepel)
library(data.table)
```

```{r}
data_cal <- read_csv('calenviroscreen-3.0-results-june-2018-update.csv')
data_cal
```


```{r}
summary(data_cal)
```

```{r}
#names(data_cal)
colnames(data_cal) <- gsub(" ", "", colnames(data_cal))
colnames(data_cal) <- gsub("\n", "", colnames(data_cal))
names(data_cal)
```

from the summary we can see there are at most 242 NAs 


Question: how do we remove NAs? do we need to keep NAs? 
What about 

*****
columns for diseases: Asthma LowBirthWeight CardiovascularDisease

columns for socio-economic elements:
 Education LinguisticIsolation Poverty Unemployment HousingBurden Pop.Char.

columns for air pollution elements: 
Ozone PM2.5 DieselPM DrinkingWater Pesticides Tox.Release
Traffic CleanupSites GroundwaterThreats Haz.Waste Imp.WaterBodies
SolidWaste PollutionBurden
*****

```{r}
air_pollutants_vec <- names(data_cal)[12:38]
air_pollutants_vec

disease_vec <- names(data_cal)[39:44]
disease_vec

soecon_vec <- names(data_cal)[45:57]
soecon_vec
```

# EDA

## EDA for Pollution factors
```{r}
#histograms for the air pollution factors
hist(data_cal$Ozone, main='Histogram of state-level Ozone concentration in the air' )

hist(data_cal$PM2.5, main='Histogram of state-level PM 2.5 concentration in the air' )

hist(data_cal$DieselPM, main='Histogram of state-level Diesel Particle concentration in the air' )

hist(data_cal$Pesticides, main='Histogram of state-level Pesticides concentration in the air' )

hist(data_cal$Tox.Release, main='Histogram of state-level Toxin concentration in the air' )


pairs(Asthma ~ Ozone + PM2.5 + DieselPM + Pesticides + Tox.Release , dat = data_cal)
```

# for other diseases

```{r}
#histograms for the other diseases factors
hist(data_cal$Asthma, main='Histogram of state-level Asthma rate(age-adjusted)' )

hist(data_cal$LowBirthWeight, main='Histogram of Low Birth Weight Prevalence' )

hist(data_cal$CardiovascularDisease, main='Histogram of state-level Cardiovascular Diseases Prevalence' )


pairs(Asthma ~ LowBirthWeight + CardiovascularDisease , dat = data_cal)
```


#for socioeconomic factors
```{r}
pairs(Asthma ~ Education + LinguisticIsolation + Poverty + Unemployment + HousingBurden, dat = data_cal)
#pairs(Pop.Char.~ Education + LinguisticIsolation + Poverty + Unemployment + HousingBurden, dat = data_cal)
```


```{r}
#forward selection
require(broom)
data_cal1 <- na.omit(data_cal)
#forward selection procedure using AIC values 
lm1 <- lm(Asthma ~ 1, data=data_cal1)
stepModel <- step(lm1, direction="forward",
scope=(~ Ozone + PM2.5 + DieselPM+ DrinkingWater+Pesticides+Tox.Release+Traffic +CleanupSites + GroundwaterThreats+ Haz.Waste + Imp.WaterBodies + 
SolidWaste + Education+LinguisticIsolation+Poverty+Unemployment+HousingBurden+ LowBirthWeight+CardiovascularDisease), data=data_cal1)

```
The desired model: 
Asthma ~ CardiovascularDisease + Poverty + Ozone + LowBirthWeight + 
    LinguisticIsolation + DieselPM + DrinkingWater + Unemployment + 
    GroundwaterThreats + Tox.Release + PM2.5 + CleanupSites + 
    PollutionBurden + Imp.WaterBodies + HousingBurden + Traffic + 
    Pesticides + Haz.Waste
    
```{r}
#stepwise selection
lm_stepwise <- lm(Asthma ~ Ozone + PM2.5 + DieselPM+ DrinkingWater+Pesticides+Tox.Release+Traffic +CleanupSites + GroundwaterThreats+ Haz.Waste + Imp.WaterBodies + 
SolidWaste + PollutionBurden + Education+LinguisticIsolation+Poverty+Unemployment+HousingBurden+LowBirthWeight+CardiovascularDisease, data=data_cal1)
stepModel <- step(lm_stepwise, direction="both")
```

The stepwise model selection method and forward selection method outputs match each other. Combined with our subject matter knowledge, we will proceed with modeling using the following covariates: Ozone + PM2.5 + DieselPM + DrinkingWater + Pesticides + 
    Tox.Release + Traffic + CleanupSites + GroundwaterThreats + 
    Haz.Waste + Imp.WaterBodies + PollutionBurden + LinguisticIsolation + 
    Poverty + Unemployment + HousingBurden + LowBirthWeight + 
    CardiovascularDisease

#### Missing Data
```{r}
#check for missing data
colnames(data_cal1)[colSums(is.na(data_cal1)) > 0]
```


#### Modeling
```{r}
#vector of covariates of interest
vec_cov <- c("Ozone", "PM2.5", "DieselPM", "DrinkingWater", "Pesticides", "Tox.Release", "Traffic", "CleanupSites", "GroundwaterThreats", "Haz.Waste", "Imp.WaterBodies", "PollutionBurden", "LinguisticIsolation", "Poverty", "Unemployment", "HousingBurden", "LowBirthWeight", "CardiovascularDisease")
```


##### Linear, additive, or other models (LASSO, ridge)
```{r}
lm_pureLinear = lm(Asthma ~ Ozone + PM2.5 + DieselPM + DrinkingWater + Pesticides + Tox.Release + Traffic + CleanupSites + GroundwaterThreats + Haz.Waste + Imp.WaterBodies + PollutionBurden + LinguisticIsolation + Poverty + Unemployment + HousingBurden + LowBirthWeight + CardiovascularDisease, data=data_cal1)
summary(lm_pureLinear)
confint(lm_pureLinear)
#Evaluation for this simple linear model
plot(lm_pureLinear)
```
This simple linear model is unsatisfactory. We can see from the plot of Residuals vs. Fitted that there's fanning trend, no equal variance above and below the line. The QQ-plot also shows non-normality with clear deviation from the diagonal line on both ends of the fitted curve.

- pesticides, traffic, hazard waste are not statistically significant. We may consider removing these covariates.

- Housing burden as a lower significance level (higher p-value) compared to other covariates may consider removing it from linear model as well.


```{r}
#remove coefficients with lower significance level, include only if coefficients are coded "***" significant
lm_rmSig = lm(Asthma ~ Ozone + PM2.5 + DieselPM + DrinkingWater + Tox.Release + CleanupSites + GroundwaterThreats + Imp.WaterBodies + PollutionBurden + LinguisticIsolation + Poverty + Unemployment + LowBirthWeight + CardiovascularDisease, data=data_cal1)
summary(lm_rmSig)
confint(lm_rmSig)
#Evaluation for this simple linear model
plot(lm_rmSig)
```
```{r}
#leave coefficients with significant level <2e-16
lm_highSig = lm(Asthma ~ Ozone + PM2.5 + DieselPM + DrinkingWater + LinguisticIsolation + Poverty + Unemployment + LowBirthWeight + CardiovascularDisease, data=data_cal1)
summary(lm_highSig)
confint(lm_highSig)
#Evaluation for this simple linear model
plot(lm_highSig)
```


```{r}
#add spline term to every term with significance level <2e-16 & PM2.5
model_spline=lm(Asthma~bSpline(Ozone,df=4) + bSpline(PM2.5, df=4) + bSpline(DieselPM, df=4) + bSpline(DrinkingWater, df=4) + Tox.Release + CleanupSites + GroundwaterThreats + Imp.WaterBodies + PollutionBurden + bSpline(LinguisticIsolation, df=4) + bSpline(Poverty, df=4) + bSpline(Unemployment, df=4) + bSpline(LowBirthWeight, df=4) + bSpline(CardiovascularDisease, df=4), data=data_cal1)
summary(model_spline)
#model evaluation
plot(model_spline)
```

```{r}
#Ridge
#define outcome variable
y <- data_cal1$Asthma
#define matrix of predictor variables
x <- data.matrix(data_cal1[, c("Ozone","PM2.5")])
library(glmnet)
#fit ridge regression model
lambda_grid <- .5 ^ (-20:20)
mod_ridge <- glmnet(x, y,alpha=0.5,family="gaussian",lambda = lambda_grid)
#view summary of model
summary(mod_ridge)
plot(mod_ridge)
```


```{r}
#Elastic Net
```


##### Logistic, Multinomial, Ordinal Model
```{r}

```

##### Poisson
```{r}

library(dplyr)
library(tidyverse)
#round the Asthma rate to make sure that it's integers
dataint <- data_cal1 |> mutate(Asthma = round(Asthma))
mod.p_base <- glm(Asthma ~ PM2.5, data=dataint, family=poisson())
summary(mod.p_base)
exp(coef(mod.p_base)[2])

```
From the summary statistics: we can see that with every 1 more unit increase in PM 2.5 concentration is estimated to be associated with, on average, 2% increase in the incidence rate of asthma among individuals that live in the counties with the current level of PM2.5 concentration.




```{r}
mod.p_ozone <- glm(Asthma ~ Ozone, data=dataint, family=poisson())
summary(mod.p_ozone)
exp(coef(mod.p_ozone)[2])
mod.p_diesel <- glm(Asthma ~ DieselPM, data=dataint, family=poisson())
summary(mod.p_diesel)
exp(coef(mod.p_diesel)[2])
```
From the summary statistics: we can see that with every 1 more unit increase in ozone concentration is estimated to be associated with, on average, 4000% increase in the incidence rate of asthma among individuals that live in the counties with the current level of ozone concentration.

From the summary statistics: we can see that with every 1 more unit increase in diesel particles is estimated to be associated with, on average, 0.5% increase in the incidence rate of asthma among individuals that live in the counties with the current level of concentration.



```{r}
mod.p_pm_diesel <- glm(Asthma ~ PM2.5 + DieselPM, data=dataint, family=poisson())
summary(mod.p_pm_diesel)
#exp(coef(mod.p_diesel)[2])
```

The percent change in PM 2.5 coefficient: (0.02 - 0.013)/0.013 > 10%
Thus, DieselPM is likely a confounder of PM 2.5

```{r}

```

```{r}
mod.p_pm_ozone <- glm(Asthma ~ PM2.5 + DieselPM+ Ozone, data=dataint, family=poisson())
summary(mod.p_pm_ozone)
```
As can see above, when modeled with Asthma rate alone, Ozone concentration has relatively high influence on asthma rates across the counties.

Now predict Asthma rate using the diseases:

```{r}

#coef(mod.p_ozone)
mod.p_diseases <- glm(Asthma ~ LowBirthWeight+CardiovascularDisease, data=dataint, family=poisson())
summary(mod.p_diseases)
```



```{r}
mod.p_soecon <- glm(Asthma ~ PollutionBurden + LinguisticIsolation + 
    Poverty + Unemployment + HousingBurden, data=dataint, family=poisson())
summary(mod.p_soecon)
```


```{r}
mod.poisson.full <- glm(Asthma ~ Ozone + PM2.5 + DieselPM + DrinkingWater + Pesticides + 
    Tox.Release + Traffic + CleanupSites + GroundwaterThreats + 
    Haz.Waste + Imp.WaterBodies + PollutionBurden + LinguisticIsolation + 
    Poverty + Unemployment + HousingBurden + LowBirthWeight + 
    CardiovascularDisease, data=dataint, family=poisson())
summary(mod.poisson.full)


```

```{r}
sort(coef(mod.poisson.full) , decreasing = TRUE)
```
From the summary statistics of the full model, the Cardiovascular Disease, Low Birth Weight and PM 2.5 are the three major contributors to Asthma rate, using Poisson models. 


Something to note: Ozone showed a very significant positive association with Asthma rate when modeled with Asthma rate alone, but showed negative association in the full model, which is open for later discussion and examinations. 



```{r}

```

